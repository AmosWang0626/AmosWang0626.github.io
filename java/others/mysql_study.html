<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.73" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://mister-hope.github.io/java/others/mysql_study.html"><meta property="og:site_name" content="JAVA技术学习笔记"><meta property="og:title" content="MySQL概览"><meta property="og:description" content="MySQL存储引擎 MyISAM、InnoDB、Memory MyISAM 不支持事务，不支持外键约束，索引文件和数据文件分开。内存中可以缓存更多的索引，对查询性能会更好，适用于那种少插入，多查询的场景。 经典案例：大数据场景下的报表系统。网站埋点日志、业务系统通过MySQL binlog同步业务数据，批量写入Hadoop后，在 T+1 进行离线批处理..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-03-06T15:29:00.000Z"><meta property="article:published_time" content="2021-04-10T00:00:00.000Z"><meta property="article:modified_time" content="2025-03-06T15:29:00.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"MySQL概览","image":[""],"datePublished":"2021-04-10T00:00:00.000Z","dateModified":"2025-03-06T15:29:00.000Z","author":[{"@type":"Person","name":"Amos Wang","url":"https://github.com/AmosWang0626"}]}</script><title>MySQL概览 | JAVA技术学习笔记</title><meta name="description" content="MySQL存储引擎 MyISAM、InnoDB、Memory MyISAM 不支持事务，不支持外键约束，索引文件和数据文件分开。内存中可以缓存更多的索引，对查询性能会更好，适用于那种少插入，多查询的场景。 经典案例：大数据场景下的报表系统。网站埋点日志、业务系统通过MySQL binlog同步业务数据，批量写入Hadoop后，在 T+1 进行离线批处理...">
    <link rel="preload" href="/assets/style-C2CVLJoD.css" as="style"><link rel="stylesheet" href="/assets/style-C2CVLJoD.css">
    <link rel="modulepreload" href="/assets/app-SLj0sVXk.js"><link rel="modulepreload" href="/assets/mysql_study.html-D8eT3fpc.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-DpmcUd6u.js" as="script"><link rel="prefetch" href="/assets/intro.html-CZNphZRY.js" as="script"><link rel="prefetch" href="/assets/index.html-DvAHOY6b.js" as="script"><link rel="prefetch" href="/assets/disable.html-ChJW8Vdb.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-DBnaNptR.js" as="script"><link rel="prefetch" href="/assets/layout.html-D6nwYRgR.js" as="script"><link rel="prefetch" href="/assets/markdown.html-DjYS2jMr.js" as="script"><link rel="prefetch" href="/assets/page.html-D35iGWOk.js" as="script"><link rel="prefetch" href="/assets/index.html-Ch9CU4LP.js" as="script"><link rel="prefetch" href="/assets/front_js_mode.html-CzoOvdKw.js" as="script"><link rel="prefetch" href="/assets/github_travel.html-BkRVddvU.js" as="script"><link rel="prefetch" href="/assets/hexo_damond.html-B8E6UBF4.js" as="script"><link rel="prefetch" href="/assets/vuepress_and_github.html-DO_8Fza6.js" as="script"><link rel="prefetch" href="/assets/index.html-Cl_Qd9EB.js" as="script"><link rel="prefetch" href="/assets/ArrayList.html-CNtab5Pq.js" as="script"><link rel="prefetch" href="/assets/HashMap.html-VgVCxVVP.js" as="script"><link rel="prefetch" href="/assets/index.html-CFaY3_tK.js" as="script"><link rel="prefetch" href="/assets/index.html-cj-b33Mu.js" as="script"><link rel="prefetch" href="/assets/design_mode.html-DgFitg9e.js" as="script"><link rel="prefetch" href="/assets/hello_world.html-BArnCZUt.js" as="script"><link rel="prefetch" href="/assets/java_concurrent.html-DQ5fKRTP.js" as="script"><link rel="prefetch" href="/assets/string_matches.html-CdHAVkHg.js" as="script"><link rel="prefetch" href="/assets/404.html-CnpSG9MA.js" as="script"><link rel="prefetch" href="/assets/index.html-B7ugNUJs.js" as="script"><link rel="prefetch" href="/assets/index.html-DFyOxOCl.js" as="script"><link rel="prefetch" href="/assets/index.html-WdJ5YSl5.js" as="script"><link rel="prefetch" href="/assets/index.html-BRZ0iRMa.js" as="script"><link rel="prefetch" href="/assets/index.html-tpEho3tt.js" as="script"><link rel="prefetch" href="/assets/index.html-B40e1C5u.js" as="script"><link rel="prefetch" href="/assets/index.html-DfYynGHA.js" as="script"><link rel="prefetch" href="/assets/index.html-DOhJryWy.js" as="script"><link rel="prefetch" href="/assets/index.html-BIU5N1b0.js" as="script"><link rel="prefetch" href="/assets/index.html-DEcykYwe.js" as="script"><link rel="prefetch" href="/assets/index.html-ZATQbRl5.js" as="script"><link rel="prefetch" href="/assets/index.html-DtJNBE4V.js" as="script"><link rel="prefetch" href="/assets/index.html-s7qiYV3q.js" as="script"><link rel="prefetch" href="/assets/index.html-CUjPnOU_.js" as="script"><link rel="prefetch" href="/assets/index.html-CtOMEuUH.js" as="script"><link rel="prefetch" href="/assets/index.html-DnZTFteL.js" as="script"><link rel="prefetch" href="/assets/index.html-Cduws1zd.js" as="script"><link rel="prefetch" href="/assets/index.html-Bh7v57tM.js" as="script"><link rel="prefetch" href="/assets/index.html-CxgIoqsR.js" as="script"><link rel="prefetch" href="/assets/index.html-BlPkh1sz.js" as="script"><link rel="prefetch" href="/assets/index.html-DzFGV_9L.js" as="script"><link rel="prefetch" href="/assets/index.html-m1bYMYF-.js" as="script"><link rel="prefetch" href="/assets/index.html-D1f_8Z8W.js" as="script"><link rel="prefetch" href="/assets/index.html-CB7hiIu_.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-DXWKOczD.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-QXEOFQJV-B1OKoiAa.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/" aria-label="带我回家"><!----><!----><span class="vp-site-name">JAVA技术学习笔记</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="主页" iconsizing="height"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:house" height="1em" sizing="height"></iconify-icon><!--]-->主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/java/" aria-label="Java技术" iconsizing="height"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:laptop-code" height="1em" sizing="height"></iconify-icon><!--]-->Java技术<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/front/" aria-label="前端技术" iconsizing="height"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:laptop-code" height="1em" sizing="height"></iconify-icon><!--]-->前端技术<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/AmosWang0626" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/" aria-label="主页" iconsizing="both"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:house" width="1em" height="1em" sizing="both"></iconify-icon><!--]-->主页<!----></a></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><iconify-icon class="vp-icon" icon="fa6-solid:book" width="1em" height="1em" sizing="both"></iconify-icon><span class="vp-sidebar-title">Java基础</span><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="vp-icon" icon="fa6-solid:laptop-code" width="1em" height="1em" sizing="both"></iconify-icon><span class="vp-sidebar-title">JDK源码剖析-基础数据结构</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><iconify-icon class="vp-icon" icon="fa6-solid:laptop-code" width="1em" height="1em" sizing="both"></iconify-icon><span class="vp-sidebar-title">其他内容</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/java/others/design_mode.html" aria-label="Java 设计模式" iconsizing="both"><!---->Java 设计模式<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/java/others/java_concurrent.html" aria-label="Java 高效并发" iconsizing="both"><!---->Java 高效并发<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/java/others/mysql_study.html" aria-label="MySQL概览" iconsizing="both"><!---->MySQL概览<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/java/others/hello_world.html" aria-label="万能的 HelloWorld" iconsizing="both"><!---->万能的 HelloWorld<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/java/others/string_matches.html" aria-label="字符串正则匹配性能对比" iconsizing="both"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:laptop-code" width="1em" height="1em" sizing="both"></iconify-icon><!--]-->字符串正则匹配性能对比<!----></a></li></ul></section></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><iconify-icon class="vp-icon" icon="fa6-solid:book" width="1em" height="1em" sizing="both"></iconify-icon><span class="vp-sidebar-title">前端相关</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/front/github_travel.html" aria-label="Github之旅" iconsizing="both"><!---->Github之旅<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/front/hexo_damond.html" aria-label="Hexo挂掉自动重启" iconsizing="both"><!---->Hexo挂掉自动重启<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/front/vuepress_and_github.html" aria-label="VuePress + Github 自动化部署" iconsizing="both"><!---->VuePress + Github 自动化部署<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/front/front_js_mode.html" aria-label="编写可维护的JavaScript" iconsizing="both"><!---->编写可维护的JavaScript<!----></a></li></ul></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/intro.html" aria-label="介绍页" iconsizing="both"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:circle-info" width="1em" height="1em" sizing="both"></iconify-icon><!--]-->介绍页<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->MySQL概览</h1><!----><hr></div><!----><!----><div class="theme-hope-content" vp-content><h2 id="mysql存储引擎" tabindex="-1"><a class="header-anchor" href="#mysql存储引擎"><span>MySQL存储引擎</span></a></h2><blockquote><p>MyISAM、InnoDB、Memory</p></blockquote><h4 id="myisam" tabindex="-1"><a class="header-anchor" href="#myisam"><span>MyISAM</span></a></h4><p>不支持事务，不支持外键约束，索引文件和数据文件分开。内存中可以缓存更多的索引，对查询性能会更好，适用于那种少插入，多查询的场景。</p><p>经典案例：大数据场景下的报表系统。网站埋点日志、业务系统通过MySQL binlog同步业务数据，批量写入Hadoop后，在 T+1 进行离线批处理计算，<br> 数据计算完，导入MySQL中，后边报表系统就可以直接从MySQL中查询已经计算好的数据，渲染成各种图，供他人使用。</p><p>但是在数据量非常多的情况下，几千万、几十亿数据时，MySQL是扛不住这么多数据的，一般建议单表500万以内数据量。</p><p>所以后来采用可配置化BI系统 + kylin + elastic search，支持大规模数据的复杂报表。</p><h4 id="innodb" tabindex="-1"><a class="header-anchor" href="#innodb"><span>InnoDB</span></a></h4><p>支持事务，强制要求主键，默认根据主键建立聚簇索引，支持外键约束。高并发（读写分离）、大数据量（分库分表）、高可用（主备切换）等相关成熟的数据库架构。</p><h2 id="mysql索引相关" tabindex="-1"><a class="header-anchor" href="#mysql索引相关"><span>MySQL索引相关</span></a></h2><h3 id="索引数据结构" tabindex="-1"><a class="header-anchor" href="#索引数据结构"><span>索引数据结构</span></a></h3><blockquote><p>B树，B+树</p></blockquote><h5 id="b树" tabindex="-1"><a class="header-anchor" href="#b树"><span>B树</span></a></h5><ul><li>平衡的多路查找树，所有叶子结点都位于同一层。</li><li>一个5阶B树，每个结点最多有4个关键字。</li><li>每个结点都能存放数据或数据地址。</li></ul><h5 id="b-树" tabindex="-1"><a class="header-anchor" href="#b-树"><span>B+树</span></a></h5><ul><li>B树的升级版，只有叶子结点才保存数据，所以每次查找次数都相同，更稳定。</li><li>另外，所有的叶子节点数据构成了一个有序链表，范围查找时性能更高。</li><li>全节点遍历时，只需要遍历所有的叶子节点即可，遍历速度更快。</li></ul><h4 id="myisam引擎中的索引实现-b-树" tabindex="-1"><a class="header-anchor" href="#myisam引擎中的索引实现-b-树"><span>MyISAM引擎中的索引实现（B+树）</span></a></h4><p>MyISAM数据文件和索引文件是分开的，所以索引文件里的data都是指向数据文件中的一行。</p><h4 id="innodb引擎中的索引实现-b-树" tabindex="-1"><a class="header-anchor" href="#innodb引擎中的索引实现-b-树"><span>InnoDB引擎中的索引实现（B+树）</span></a></h4><ul><li><p>聚簇索引</p><blockquote><p>强制要求主键，默认根据主键建立一个聚簇索引。数据文件本身就存在于根据主键建立的聚簇索引中。</p><p>如果没有主键，MySQL会自动找一个唯一列、或者隐式定义一个主键DB_ROW_ID，以此来创建聚簇索引。</p></blockquote></li><li><p>非聚簇索引</p><ul><li>如果查询的列，索引中完全包含，也就是覆盖索引，直接从索引中返回数据即可。</li><li>如果查询的列，索引中不完全包含，那就会回表查询，根据索引中指向的地址，去聚簇索引中获取数据。</li></ul></li></ul><p>所以，在 InnoDB引擎里边，按照主键ID查询数据是很快的。</p><h4 id="innodb引擎两个建议" tabindex="-1"><a class="header-anchor" href="#innodb引擎两个建议"><span>InnoDB引擎两个建议</span></a></h4><ol><li>不推荐使用 UUID 作为主键</li><li>推荐使用 自增ID 作为主键</li></ol><p>原因如下：</p><ul><li>UUID 作为主键，键值32位字符串，多消耗磁盘空间，会使索引文件变大。</li><li>自增ID 是有序的，数据插入时，磁盘的顺序读写性能更高，也天然适合范围查找。</li><li>UUID 生成的字符串是无序的，插入时，频繁移动磁盘块，自然性能就会低一些。</li></ul><h2 id="索引使用规则" tabindex="-1"><a class="header-anchor" href="#索引使用规则"><span>索引使用规则</span></a></h2><ol><li>全列匹配（联合索引，作为条件时要是有序的）</li><li>最左原则（如果没法全列匹配，要遵守最左原则，尽可能使最左的索引有较好区分度）</li><li>前缀匹配（like &quot;xxx%&quot;，%不能放前边&quot;%xxx%&quot;）</li><li>范围列匹配（符合最左原则才可以范围匹配，同时范围之后的无法使用索引）</li><li>函数不能使用索引</li></ol><p>索引缺点，注意事项</p><ul><li>插入性能会降低</li><li>尽量少创建索引，2~3个</li><li>索引区分度要高（id【推荐】、status(0, 1)【区分度太低】）</li></ul><h2 id="事务" tabindex="-1"><a class="header-anchor" href="#事务"><span>事务</span></a></h2><h4 id="事务的acid" tabindex="-1"><a class="header-anchor" href="#事务的acid"><span>事务的ACID</span></a></h4><ol><li>原子性（Atomic） <blockquote><p>要么一起成功，要么一起失败</p></blockquote></li><li>一致性（Consistency） <blockquote><p>SQL执行前后，数据是一致的</p></blockquote></li><li>隔离性（Isolation） <blockquote><p>多个事务之间不能相互干扰</p></blockquote></li><li>持久性（Durability） <blockquote><p>事务成功，修改的结果是持久的</p></blockquote></li></ol><h4 id="事务隔离级别" tabindex="-1"><a class="header-anchor" href="#事务隔离级别"><span>事务隔离级别</span></a></h4><ol><li>读未提交 <blockquote><p>可以读到其他事务没有提交的数据，如果别的事务后边没提交，这就不对了</p></blockquote></li><li>读已提交(RC)【Oracle默认】 <blockquote><p>可以读到已提交的数据。</p></blockquote></li><li>可重复读(RR)【MySQL默认】 <blockquote><p>通过MVCC来保证，在一个事务里边，多次读同一行数据，无论别的事务怎么修改，本事务读到的内容是一样的。</p></blockquote></li><li>串行化 <blockquote><p>用来解决幻读的，不过这样会导致性能低下。</p></blockquote></li></ol><h4 id="mysql-innodb如何实现可重复读-rr" tabindex="-1"><a class="header-anchor" href="#mysql-innodb如何实现可重复读-rr"><span>MySQL InnoDB如何实现可重复读(RR)</span></a></h4><p>在 InnoDB 引擎下，会为每一行保存两个事务ID：(1)创建的事务ID；(2)删除的事务ID。</p><h5 id="删除" tabindex="-1"><a class="header-anchor" href="#删除"><span>删除</span></a></h5><table><thead><tr><th>id</th><th>name</th><th>创建事务ID</th><th>删除事务ID</th></tr></thead><tbody><tr><td>1</td><td>张三</td><td>120</td><td>空</td></tr><tr><td>2</td><td>李四</td><td>121</td><td>空</td></tr></tbody></table><ul><li>事务120进来，插入了一条数据id=1</li><li>事务121进来，插入了一条数据id=2</li><li>事务122进来，删除了id=1的数据</li></ul><p><strong>之后的数据长这样</strong>：</p><table><thead><tr><th>id</th><th>name</th><th>创建事务ID</th><th>删除事务ID</th></tr></thead><tbody><tr><td>1</td><td>张三</td><td>120</td><td>122</td></tr><tr><td>2</td><td>李四</td><td>121</td><td>空</td></tr></tbody></table><p>那么，事务120还能查到id=1的数据吗？</p><blockquote><p>答：可以的，事务120读取的时候，可以读到 创建事务ID &lt;= 当前事务ID，以及当前事务ID &lt;= 删除事务ID。</p></blockquote><h5 id="修改" tabindex="-1"><a class="header-anchor" href="#修改"><span>修改</span></a></h5><table><thead><tr><th>id</th><th>name</th><th>创建事务ID</th><th>删除事务ID</th></tr></thead><tbody><tr><td>1</td><td>张三</td><td>120</td><td>空</td></tr><tr><td>2</td><td>李四</td><td>121</td><td>空</td></tr></tbody></table><ul><li>事务120进来，插入了一条数据id=1</li><li>事务121进来，插入了一条数据id=2</li><li>事务122进来，修改id=1的数据，name=小明</li></ul><p><strong>之后的数据长这样</strong>：</p><table><thead><tr><th>id</th><th>name</th><th>创建事务ID</th><th>删除事务ID</th></tr></thead><tbody><tr><td>1</td><td>张三</td><td>120</td><td>空</td></tr><tr><td>2</td><td>李四</td><td>121</td><td>空</td></tr><tr><td>1</td><td>小明</td><td>122</td><td>空</td></tr></tbody></table><p>那么，事务120查询id=1的数据的name是啥呢？</p><blockquote><p>答：张三。事务120读取的时候，只能读到 创建事务ID &lt;= 当前事务ID 的数据；InnoDB里边，<br> 如果有不同的事务修改同一行数据，此时每个事务都会创建一个数据行的快照再进行修改。</p></blockquote><h2 id="mysql锁" tabindex="-1"><a class="header-anchor" href="#mysql锁"><span>MySQL锁</span></a></h2><h3 id="_1-表锁、行锁" tabindex="-1"><a class="header-anchor" href="#_1-表锁、行锁"><span>（1）表锁、行锁</span></a></h3><h4 id="表锁" tabindex="-1"><a class="header-anchor" href="#表锁"><span>表锁</span></a></h4><p>在MyISAM引擎下，一般MyISAM会加表锁：</p><ul><li>执行查询时，会默认加个表共享锁，也就是表读锁，这个时候别人只能来查，不能写数据；</li><li>写操作的时候，会给表加独占锁，也就是表写锁，别人不能读也不能写。</li></ul><p>在InnoDB引擎下：</p><ul><li>意向共享锁，就是加共享行锁的时候，必须先加这个共享表锁；</li><li>意向排它锁，就是给某行加排它锁的时候，必须先给表加排它锁。</li></ul><p>注意：这个表锁，是InnoDB引擎自动加的，无需手动加锁。</p><h4 id="行锁" tabindex="-1"><a class="header-anchor" href="#行锁"><span>行锁</span></a></h4><p>InnoDB的行锁有共享锁（S）和排它锁（X）两种。</p><ul><li>共享锁：多个事务可以加共享锁读同一行数据，但是别的事务不能写这行数据；</li><li>排它锁：就是一个事务可以写这行数据，其他事务只能读，不能写。</li></ul><hr><ul><li><p>自动加锁</p><ul><li>insert/update/delete操作会加行级排它锁。</li><li>select，InnoDB不会加锁。因为InnoDB默认实现了可重复读，也就是MVCC机制，多个事务随便读，各自有快照。</li></ul></li><li><p>手动加锁</p><ul><li>手动加共享锁：<code>select * from table where id = 1 lock in share mode</code>，然后其他事务就不能来修改这行数据了。</li><li>手动加排它锁：<code>select * from table where id = 1 for update</code>，然后其他事务修改会被hang住，慎用！</li></ul></li></ul><h3 id="_2-悲观锁和乐观锁" tabindex="-1"><a class="header-anchor" href="#_2-悲观锁和乐观锁"><span>（2）悲观锁和乐观锁</span></a></h3><p>悲观锁：</p><blockquote><p>只能我自己来操作，别人都操作不了。</p></blockquote><p><code>select * fromo table where id = 1 for update</code></p><p>乐观锁：</p><blockquote><p>通过版本控制，如果别人修改了，我就不修改了，或者重新获取新值，再进行修改。有点CAS的意思。</p></blockquote><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> id, username, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">version</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> id </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">update</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> username </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;New Name&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    version</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">  =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> #{old_version} + </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> id </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  and</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> version</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> #{old_version};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-死锁" tabindex="-1"><a class="header-anchor" href="#_3-死锁"><span>（3）死锁</span></a></h3><p>多个事务竞争同一把锁，就会形成死锁。</p><p>实战：</p><blockquote><p>死锁相对常见，如下</p></blockquote><ol><li>有些时候，调整事务隔离级别可以解决。 <ul><li>查看事务隔离级别 <code>SELECT @@tx_isolation;</code></li><li>修改数据库默认事务隔离级别；代码中配置事务隔离级别；多租户下，连接池设置事务隔离级别</li></ul></li><li>看下哪里死锁了 <ul><li><code>Lock wait timeout exceeded; try restarting transaction</code></li><li>查看死锁SQL <code>select * from information_schema.innodb_trx;</code></li></ul></li></ol><h2 id="mysql调优手段" tabindex="-1"><a class="header-anchor" href="#mysql调优手段"><span>MySQL调优手段</span></a></h2><ul><li>尽可能单表查询，加上索引，join相关的逻辑放在代码里边</li><li>explain对应SQL，看是否命中了索引，索引扫描了多少行</li></ul><h2 id="主键数据类型选型" tabindex="-1"><a class="header-anchor" href="#主键数据类型选型"><span>主键数据类型选型</span></a></h2><p>推荐使用自增ID，那么如果自增ID用完了怎么办？</p><ul><li><p>int</p><ul><li>带符号 -21,4748,3648 ~ 21,4748,3647</li><li>无符号 0 ~ 42,9496,7295（约42亿）</li></ul></li><li><p>bigint</p><ul><li>带符号 -922,3372,0368,5477,5808 ~ 922,3372,0368,5477,5807</li><li>无符号 0 ~ 1844,6744,0737,0955,1615</li></ul></li></ul><ol><li>默认是int类型，自增ID最大值 4294967295，可以改为bigint类型 <ul><li>怎么修改，直接Alter修改肯定需要停服，大概率是可以停服的</li><li>如果不可以停服，主从切换，分别修改</li></ul></li><li>另外，单表数据量过亿，系统肯定早就应该重构了 <ul><li>分库分表概括一下</li><li>分库分表主键ID可采用雪花算法，或者其他分布式ID解决方案</li></ul></li></ol><h2 id="幂等性" tabindex="-1"><a class="header-anchor" href="#幂等性"><span>幂等性</span></a></h2><p><code>INSERT INTO ... ON DUPLICATE KEY UPDATE</code> 语法，不存在时插⼊，存在时更新，是天然⽀持幂等性的。</p><p><code>REPLACE INTO ...</code> 如果唯一键存在就更新。</p><p><code>INSERT IGNORE INTO ...</code> 如果唯一键存在就不插入，也可以解决并发插入的问题。</p></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/AmosWang0626/edit/main/src/java/others/mysql_study.md" aria-label="在 GitHub 上编辑此页" rel="noopener noreferrer" target="_blank" iconsizing="both"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><span class="vp-meta-info" data-allow-mismatch="text">2025/3/6 15:29:00</span></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 1833063210@qq.com">amos.wang</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/java/others/java_concurrent.html" aria-label="Java 高效并发" iconsizing="both"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Java 高效并发</div></a><a class="route-link auto-link next" href="/java/others/hello_world.html" aria-label="万能的 HelloWorld" iconsizing="both"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">万能的 HelloWorld<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2025 Amos Wang </div></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-SLj0sVXk.js" defer></script>
  </body>
</html>
